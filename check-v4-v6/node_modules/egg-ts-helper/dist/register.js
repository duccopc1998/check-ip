"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Register = void 0;
const cluster_1 = __importDefault(require("cluster"));
const util_1 = require("util");
const core_1 = __importDefault(require("./core"));
const utils_1 = require("./utils");
const debug = (0, util_1.debuglog)('egg-ts-helper#register');
class Register {
    constructor(options) {
        this.tsHelperClazz = options?.tsHelperClazz || core_1.default;
    }
    init(options) {
        /* istanbul ignore else */
        if (!cluster_1.default.isMaster)
            return;
        // make sure ets only run once
        const pid = process.env.ETS_REGISTER_PID;
        if (pid) {
            debug('egg-ts-helper watcher has ran in %s', pid);
            return;
        }
        const watch = (0, utils_1.convertString)(process.env.ETS_WATCH, process.env.NODE_ENV !== 'test');
        const clazz = this.tsHelperClazz;
        const cwd = options?.cwd || process.cwd();
        const instance = new clazz({ watch, ...options });
        if ((0, utils_1.checkMaybeIsJsProj)(cwd)) {
            // write jsconfig if the project is wrote by js
            (0, utils_1.writeJsConfig)(cwd);
        }
        else {
            const tsNodeMode = process.env.EGG_TYPESCRIPT === 'true';
            // no need to clean in js project
            // clean local js file at first.
            // because egg-loader cannot load the same property name to egg.
            if (tsNodeMode && instance.config.autoRemoveJs) {
                (0, utils_1.cleanJs)(cwd);
            }
        }
        // cache pid to env, prevent child process executing ets again
        process.env.ETS_REGISTER_PID = `${process.pid}`;
        debug('start buidling');
        // exec building
        instance.build();
        debug('end');
        // reset ETS_REGISTER_PID
        process.env.ETS_REGISTER_PID = '';
    }
}
exports.default = Register;
exports.Register = Register;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVnaXN0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsc0RBQThCO0FBQzlCLCtCQUFnQztBQUNoQyxrREFBa0Q7QUFDbEQsbUNBRWlCO0FBRWpCLE1BQU0sS0FBSyxHQUFHLElBQUEsZUFBUSxFQUFDLHdCQUF3QixDQUFDLENBQUM7QUFNakQsTUFBcUIsUUFBUTtJQUczQixZQUFZLE9BQXdCO1FBQ2xDLElBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxFQUFFLGFBQWEsSUFBSSxjQUFRLENBQUM7SUFDMUQsQ0FBQztJQUVELElBQUksQ0FBQyxPQUF3QjtRQUMzQiwwQkFBMEI7UUFDMUIsSUFBSSxDQUFDLGlCQUFPLENBQUMsUUFBUTtZQUFFLE9BQU87UUFFOUIsOEJBQThCO1FBQzlCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNSLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNsRCxPQUFPO1FBQ1QsQ0FBQztRQUVELE1BQU0sS0FBSyxHQUFHLElBQUEscUJBQWEsRUFBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsQ0FBQztRQUNwRixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ2pDLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzFDLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUVsRCxJQUFJLElBQUEsMEJBQWtCLEVBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUM1QiwrQ0FBK0M7WUFDL0MsSUFBQSxxQkFBYSxFQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEtBQUssTUFBTSxDQUFDO1lBRXpELGlDQUFpQztZQUNqQyxnQ0FBZ0M7WUFDaEMsZ0VBQWdFO1lBQ2hFLElBQUksVUFBVSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQy9DLElBQUEsZUFBTyxFQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsQ0FBQztRQUNILENBQUM7UUFFRCw4REFBOEQ7UUFDOUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVoRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN4QixnQkFBZ0I7UUFDaEIsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2pCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNiLHlCQUF5QjtRQUN6QixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0NBQ0Y7QUEvQ0QsMkJBK0NDO0FBRVEsNEJBQVEifQ==